Replit, migrate my editor to Lexical (no overlay). Do the following exactly:

Install deps

npm i lexical @lexical/react @lexical/rich-text @lexical/history @lexical/utils @lexical/selection @lexical/html


Create src/components/RichTextEditorLexical.tsx with this code:

import {useMemo} from "react";
import {LexicalComposer} from "@lexical/react/LexicalComposer";
import {RichTextPlugin} from "@lexical/react/LexicalRichTextPlugin";
import {HistoryPlugin} from "@lexical/react/LexicalHistoryPlugin";
import {ContentEditable} from "@lexical/react/LexicalContentEditable";
import {OnChangePlugin} from "@lexical/react/LexicalOnChangePlugin";
import {HeadingNode} from "@lexical/rich-text";
import {FORMAT_TEXT_COMMAND, $getSelection, $isRangeSelection, $setBlocksType} from "lexical";
import { $generateHtmlFromNodes } from "@lexical/html";

type Props = {
  value?: string;                    // initial HTML (optional)
  onChange?: (html: string) => void; // returns HTML on changes
  placeholder?: string;
  readOnly?: boolean;
};

export default function RichTextEditorLexical({value = "", onChange, placeholder, readOnly}: Props) {
  const initialConfig = useMemo(() => ({
    namespace: "retro-journal",
    editable: !readOnly,
    nodes: [HeadingNode],
    onError: (e: any) => console.error(e),
    theme: {
      paragraph: "rte-p",
      text: { bold: "rte-bold", italic: "rte-italic", underline: "rte-underline" },
      heading: { h1: "rte-h rte-h1", h2: "rte-h rte-h2", h3: "rte-h rte-h3" },
    },
    editorState: (editor: any) => {
      if (!value) return;
      // naive HTML import: put raw HTML in the editor
      const div = document.createElement("div");
      div.innerHTML = value;
      editor.update(() => {
        const root = (editor as any).getRootElement?.();
      });
    },
  }), [value, readOnly]);

  return (
    <LexicalComposer initialConfig={initialConfig}>
      {!readOnly && <Toolbar/>}
      <RichTextPlugin
        contentEditable={<ContentEditable className="rte-editable" />}
        placeholder={<div className="rte-placeholder">{placeholder || "Start typing…"}</div>}
      />
      <HistoryPlugin />
      <OnChangePlugin onChange={(editorState, editor) => {
        editorState.read(() => {
          const html = $generateHtmlFromNodes(editor);
          onChange?.(html);
        });
      }}/>
    </LexicalComposer>
  );
}

function Toolbar() {
  const setHeading = (level: 1|2|3|"p") => {
    (window as any).$lexicalEditor?.update(() => {
      const selection = $getSelection();
      if ($isRangeSelection(selection)) {
        if (level === "p") {
          $setBlocksType(selection, () => document.createElement("p") as any);
        } else {
          // use HeadingNode from @lexical/rich-text
          const { $createHeadingNode } = require("@lexical/rich-text");
          $setBlocksType(selection, () => $createHeadingNode(("h"+level) as any));
        }
      }
    });
  };
  const toggle = (cmd: "bold"|"italic"|"underline") =>
    (window as any).$lexicalEditor?.dispatchCommand(FORMAT_TEXT_COMMAND, cmd);

  return (
    <div className="rte-toolbar">
      <button type="button" onClick={() => toggle("bold")}>B</button>
      <button type="button" onClick={() => toggle("italic")}>I</button>
      <button type="button" onClick={() => toggle("underline")}>U</button>
      <select defaultValue="p" onChange={(e) => setHeading(e.target.value as any)}>
        <option value="p">Normal</option>
        <option value="1">H1</option>
        <option value="2">H2</option>
        <option value="3">H3</option>
      </select>
    </div>
  );
}


Add styles to src/styles/editor.css (or your global CSS):

.rte-editable {
  font-family: ChicagoFLFExact, Geneva, Arial, sans-serif;
  font-size: 12px;
  line-height: 12px;            /* single-pixel grid */
  letter-spacing: 0;
  white-space: pre-wrap;
  outline: none;
  min-height: 260px;
  box-sizing: border-box;
  padding: 12px;
  border: 1px solid var(--mac-black);
  background: transparent;
}

/* toolbar */
.rte-toolbar { display:flex; gap:8px; margin:4px 0 6px; }
.rte-toolbar button, .rte-toolbar select { font-size:12px; padding:2px 6px; }

/* normalize paragraphs and headings to stay on the 12px grid */
.rte-p { margin: 0; line-height: 12px; }
.rte-h { margin: 0; font-weight: 700; font-size: inherit; line-height: 12px; }
.rte-h1, .rte-h2, .rte-h3 { display: inline; } /* optional: inline look like your mock */

/* text styles */
.rte-bold { font-weight: 700; }
.rte-italic { font-style: italic; }
.rte-underline { text-decoration: underline; }

/* placeholder */
.rte-placeholder { opacity: .5; padding: 12px; pointer-events: none; }


Use it where RichTextEditor was used. Replace the import:

// import RichTextEditor from "./RichTextEditor"   // REMOVE the overlay version
import RichTextEditorLexical from "./RichTextEditorLexical";

<RichTextEditorLexical
  value={initialHtml /* optional */}
  onChange={(html) => setValue(html)}
  placeholder="New journal entry..."
/>


Delete the overlay code (the textarea + FormattedTextDisplay preview) so it doesn’t run anymore. You no longer need the caret/selection hacks, heading regex, or line-height calibrator.

(Optional) Keep your “Catharsis” tags later
Once the editor works, we can add a small Lexical “mark”/SpanNode to highlight [stress-angry]…[/stress-angry] as you type. But first, get the base editor working.